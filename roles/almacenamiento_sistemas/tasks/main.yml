---
# üìå Rol: Administraci√≥n de almacenamiento

# ‚úÖ 1. Instalar herramientas de gesti√≥n de almacenamiento
- name: Instalar herramientas de almacenamiento
  become: yes
  ansible.builtin.package:
    name:
      - lvm2
      - parted
      - e2fsprogs
      - xfsprogs
      - logrotate
    state: present

# ‚úÖ 2. Verificar y crear grupo de vol√∫menes LVM si est√° habilitado
- name: Verificar si existe el grupo de vol√∫menes
  become: yes
  ansible.builtin.command: "vgs {{ volume_group_name }}"
  register: vg_check
  failed_when: false
  changed_when: false
  when: lvm_enabled | default(false)

- name: Mostrar informaci√≥n del grupo de vol√∫menes (si existe)
  ansible.builtin.debug:
    msg: "Grupo de vol√∫menes {{ volume_group_name }} encontrado"
  when: 
    - lvm_enabled | default(false)
    - vg_check.rc == 0

# ‚úÖ 3. Crear directorios de montaje para vol√∫menes l√≥gicos
- name: Crear directorios de montaje
  become: yes
  ansible.builtin.file:
    path: "{{ item.mount_point }}"
    state: directory
    mode: '0755'
  loop: "{{ logical_volumes }}"
  when: lvm_enabled | default(false)

# ‚úÖ 4. Configurar rotaci√≥n de logs
- name: Configurar rotaci√≥n de logs
  become: yes
  ansible.builtin.template:
    src: logrotate.j2
    dest: "/etc/logrotate.d/lab-logs"
    owner: root
    group: root
    mode: '0644'
  when: log_rotation_enabled | default(false)

# ‚úÖ 5. Crear script de monitoreo de espacio en disco
- name: Crear script de monitoreo de disco
  become: yes
  ansible.builtin.template:
    src: disk_monitor.sh.j2
    dest: "/usr/local/bin/disk_monitor.sh"
    owner: root
    group: root
    mode: '0755'
  when: disk_monitoring_enabled | default(false)

# ‚úÖ 6. Configurar cron para monitoreo de disco
- name: Configurar monitoreo autom√°tico de disco
  become: yes
  ansible.builtin.cron:
    name: "Monitoreo de espacio en disco"
    minute: "{{ disk_check_interval | default('*/15') }}"
    job: "/usr/local/bin/disk_monitor.sh"
    user: root
  when: disk_monitoring_enabled | default(false)

# ‚úÖ 7. Crear directorio de backups
- name: Crear directorio de backups
  become: yes
  ansible.builtin.file:
    path: "{{ backup_destination }}"
    state: directory
    owner: root
    group: root
    mode: '0750'
  when: backup_enabled | default(false)

# ‚úÖ 8. Configurar script de backup autom√°tico
- name: Crear script de backup
  become: yes
  ansible.builtin.template:
    src: backup_script.sh.j2
    dest: "/usr/local/bin/backup_lab.sh"
    owner: root
    group: root
    mode: '0755'
  when: backup_enabled | default(false)

# ‚úÖ 9. Programar backup autom√°tico
- name: Programar backup autom√°tico
  become: yes
  ansible.builtin.cron:
    name: "Backup autom√°tico del laboratorio"
    minute: "{{ backup_schedule.minute | default('30') }}"
    hour: "{{ backup_schedule.hour | default('1') }}"
    job: "/usr/local/bin/backup_lab.sh"
    user: root
  when: backup_enabled | default(false)

# ‚úÖ 10. Configurar limpieza autom√°tica de archivos antiguos
- name: Programar limpieza autom√°tica
  become: yes
  ansible.builtin.cron:
    name: "Limpieza de archivos antiguos - {{ item.path }}"
    minute: "0"
    hour: "3"
    weekday: "0"
    job: "find {{ item.path }} -type f -mtime +{{ item.age_days | default(7) }} -delete"
    user: root
  loop: "{{ cleanup_targets }}"
  when: auto_cleanup_enabled | default(false)

# ‚úÖ 11. Verificar uso actual de disco
- name: Verificar uso actual de disco
  become: yes
  ansible.builtin.command: "df -h"
  register: disk_usage
  changed_when: false

- name: Mostrar uso actual de disco
  ansible.builtin.debug:
    var: disk_usage.stdout_lines
