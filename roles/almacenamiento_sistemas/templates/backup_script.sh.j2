#!/bin/bash
# Script de backup automático para el laboratorio
# Generado automáticamente por Ansible

BACKUP_DIR="{{ backup_destination }}"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS={{ backup_retention_days | default(30) }}
LOG_FILE="/var/log/backup_lab.log"

# Función de logging
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log_message "Iniciando backup automático..."

# Crear directorio de backup si no existe
mkdir -p "$BACKUP_DIR"

# Backup de directorios importantes
{% for path in backup_paths %}
if [ -d "{{ path }}" ]; then
    log_message "Realizando backup de {{ path }}..."
    BACKUP_NAME="backup_$(basename {{ path }})_$DATE.tar.gz"
    tar -czf "$BACKUP_DIR/$BACKUP_NAME" -C "$(dirname {{ path }})" "$(basename {{ path }})" 2>/dev/null
    
    if [ $? -eq 0 ]; then
        log_message "Backup de {{ path }} completado: $BACKUP_NAME"
    else
        log_message "ERROR: Falló el backup de {{ path }}"
    fi
else
    log_message "ADVERTENCIA: El directorio {{ path }} no existe"
fi

{% endfor %}

# Limpiar backups antiguos
log_message "Limpiando backups antiguos (> $RETENTION_DAYS días)..."
find "$BACKUP_DIR" -name "backup_*.tar.gz" -type f -mtime +$RETENTION_DAYS -delete

# Verificar espacio disponible
SPACE_USED=$(du -sh "$BACKUP_DIR" | cut -f1)
log_message "Espacio usado por backups: $SPACE_USED"

# Mostrar estadísticas
BACKUP_COUNT=$(ls -1 "$BACKUP_DIR"/backup_*.tar.gz 2>/dev/null | wc -l)
log_message "Total de archivos de backup: $BACKUP_COUNT"

log_message "Backup automático completado."