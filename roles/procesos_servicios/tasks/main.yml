---
# ðŸ“Œ Rol 1: GestiÃ³n de procesos y servicios

# âœ… 1. Verificar si ciertos servicios estÃ¡n activos
- name: Verificar estado de servicios esenciales
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: started
    enabled: yes
  loop:
    - sshd  # Corregido: usar sshd en lugar de ssh
    - crond  # Corregido: usar crond en lugar de cron (Fedora)
    - systemd-logind
  ignore_errors: yes  # Ignorar errores si algunos servicios no existen
  tags: servicios

# Opcional: crear un directorio de logs en el host remoto si se definiÃ³ `logs_dir`
- name: Crear directorio de logs remoto (opcional)
  become: yes
  ansible.builtin.file:
    path: "{{ logs_dir }}"
    state: directory
    owner: "{{ lookup('env','USER') | default('root') }}"
    group: "{{ lookup('env','USER') | default('root') }}"
    mode: '0755'
  when: logs_dir is defined and logs_dir != ''

# Generar archivos temporales en /tmp y traerlos al controlador (mÃ©todo mÃ¡s fiable/portÃ¡til)
- name: Generar archivo temporal de servicios activos
  become: yes
  ansible.builtin.shell: "systemctl --type=service --state=running > /tmp/servicios_activos.txt"
  changed_when: false

- name: Copiar servicios activos al controlador (fetch)
  fetch:
    src: /tmp/servicios_activos.txt
    dest: ./logs/
    flat: yes

- name: Generar archivo temporal de procesos memoria
  become: yes
  ansible.builtin.shell: "ps aux --sort=-%mem | head -n 5 > /tmp/procesos_memoria.txt"
  changed_when: false

- name: Copiar procesos memoria al controlador
  fetch:
    src: /tmp/procesos_memoria.txt
    dest: ./logs/
    flat: yes

- name: Generar archivo temporal de procesos CPU
  become: yes
  ansible.builtin.shell: "ps aux --sort=-%cpu | head -n 5 > /tmp/procesos_cpu.txt"
  changed_when: false

- name: Copiar procesos CPU al controlador
  fetch:
    src: /tmp/procesos_cpu.txt
    dest: ./logs/
    flat: yes
