---
# ğŸ‘¥ Rol: GestiÃ³n Avanzada de Usuarios, Grupos y Permisos - Nivel 4 AcadÃ©mico

# =================== GESTIÃ“N DE GRUPOS ===================

- name: "ğŸ‘¥ Crear grupos del sistema necesarios"
  become: yes
  ansible.builtin.group:
    name: "{{ item.name }}"
    gid: "{{ item.gid | default(omit) }}"
    state: present
  loop:
    - { name: "admin_users", gid: 2000 }
    - { name: "developers", gid: 2001 }
    - { name: "operators", gid: 2002 }
    - { name: "backup_users", gid: 2003 }
    - { name: "audit_users", gid: 2004 }
  tags: groups

- name: "ğŸ“‹ Mostrar grupos creados"
  ansible.builtin.debug:
    msg: "âœ… Grupo {{ item.name }} creado con GID {{ item.gid | default('automÃ¡tico') }}"
  loop:
    - { name: "admin_users", gid: 2000 }
    - { name: "developers", gid: 2001 }
    - { name: "operators", gid: 2002 }
    - { name: "backup_users", gid: 2003 }
    - { name: "audit_users", gid: 2004 }
  tags: groups

# =================== CREACIÃ“N DE USUARIOS ===================

- name: "ğŸ‘¤ Crear usuarios del laboratorio con configuraciÃ³n completa"
  become: yes
  ansible.builtin.user:
    name: "{{ item.username }}"
    uid: "{{ item.uid | default(omit) }}"
    group: "{{ item.primary_group }}"
    groups: "{{ item.groups | join(',') if item.groups is defined else omit }}"
    home: "/home/{{ item.username }}"
    create_home: yes
    shell: "{{ item.shell | default('/bin/bash') }}"
    password: "{{ item.password | password_hash('sha512') if item.password is defined else '!' }}"
    comment: "{{ item.description }}"
    state: present
  loop:
    - username: "lab_admin"
      uid: 3000
      primary_group: "admin_users" 
      groups: ["sudo", "adm", "audit_users"]
      description: "Administrador del laboratorio"
      shell: "/bin/bash"
    - username: "lab_operator"
      uid: 3001
      primary_group: "operators"
      groups: ["backup_users"]
      description: "Operador del laboratorio"
      shell: "/bin/bash"
    - username: "lab_developer"
      uid: 3002
      primary_group: "developers"
      groups: ["operators"]
      description: "Desarrollador del laboratorio"
      shell: "/bin/bash"
    - username: "lab_audit"
      uid: 3003
      primary_group: "audit_users"
      groups: []
      description: "Usuario de auditorÃ­a (solo lectura)"
      shell: "/bin/bash"
    - username: "lab_backup"
      uid: 3004
      primary_group: "backup_users"
      groups: []
      description: "Usuario para tareas de backup"
      shell: "/bin/bash"
  tags: users

- name: "ğŸ“Š Mostrar usuarios creados"
  ansible.builtin.debug:
    msg: "âœ… Usuario {{ item.username }} ({{ item.description }}) creado en grupo {{ item.primary_group }}"
  loop:
    - username: "lab_admin"
      primary_group: "admin_users"
      description: "Administrador del laboratorio"
    - username: "lab_operator"
      primary_group: "operators"
      description: "Operador del laboratorio"
    - username: "lab_developer"
      primary_group: "developers" 
      description: "Desarrollador del laboratorio"
    - username: "lab_audit"
      primary_group: "audit_users"
      description: "Usuario de auditorÃ­a"
    - username: "lab_backup"
      primary_group: "backup_users"
      description: "Usuario para backups"
  tags: users

# =================== CONFIGURACIÃ“N DE DIRECTORIOS ===================

- name: "ğŸ“ Crear directorios de trabajo para cada grupo"
  become: yes
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    owner: "{{ item.owner }}"
    group: "{{ item.group }}"
    mode: "{{ item.mode }}"
  loop:
    - path: "/home/shared/admin"
      owner: "root"
      group: "admin_users"
      mode: "0750"
    - path: "/home/shared/development"
      owner: "root"
      group: "developers"
      mode: "0770"
    - path: "/home/shared/operations"
      owner: "root"
      group: "operators"
      mode: "0755"
    - path: "/home/shared/backups"
      owner: "root"
      group: "backup_users"
      mode: "0750"
    - path: "/home/shared/audit"
      owner: "root"
      group: "audit_users"
      mode: "0555"
  tags: directories

# =================== CONFIGURACIÃ“N DE SUDO ===================

- name: "ğŸ” Crear configuraciÃ³n sudo personalizada"
  become: yes
  ansible.builtin.copy:
    dest: /etc/sudoers.d/lab-users
    content: |
      # ConfiguraciÃ³n sudo para usuarios del laboratorio
      
      # Administradores tienen acceso completo
      %admin_users ALL=(ALL:ALL) ALL
      
      # Operadores pueden reiniciar servicios y gestionar procesos
      %operators ALL=(ALL) NOPASSWD: /bin/systemctl restart *, /bin/systemctl stop *, /bin/systemctl start *, /bin/kill, /bin/killall
      
      # Desarrolladores pueden instalar paquetes y acceder a logs
      %developers ALL=(ALL) NOPASSWD: /usr/bin/apt, /usr/bin/pip*, /bin/cat /var/log/*, /bin/tail /var/log/*
      
      # Usuarios de backup pueden acceder a directorios de datos
      %backup_users ALL=(ALL) NOPASSWD: /bin/tar, /bin/rsync, /bin/cp
      
      # Usuarios de auditorÃ­a solo pueden leer logs y configuraciones
      %audit_users ALL=(ALL) NOPASSWD: /bin/cat /etc/*, /bin/cat /var/log/*, /bin/ls
    mode: '0440'
    validate: 'visudo -cf %s'
  tags: sudo

# =================== POLÃTICAS DE CONTRASEÃ‘AS ===================

- name: "ğŸ”’ Instalar herramientas de polÃ­ticas de contraseÃ±a"
  become: yes
  ansible.builtin.package:
    name:
      - libpam-pwquality
      - passwd
    state: present
  when: ansible_facts['os_family'] == "Debian"
  tags: password_policy

- name: "ğŸ“‹ Configurar polÃ­ticas de contraseÃ±as robustas"
  become: yes
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-password
    regexp: '^password.*pam_pwquality.so'
    line: 'password requisite pam_pwquality.so retry=3 minlen=12 dcredit=-1 ucredit=-1 ocredit=-1 lcredit=-1 difok=3'
    backup: yes
  when: ansible_facts['os_family'] == "Debian"
  tags: password_policy

- name: "â° Configurar expiraciÃ³n de contraseÃ±as"
  become: yes
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    backup: yes
  loop:
    - regexp: '^PASS_MAX_DAYS'
      line: 'PASS_MAX_DAYS 90'
    - regexp: '^PASS_MIN_DAYS'
      line: 'PASS_MIN_DAYS 1'
    - regexp: '^PASS_WARN_AGE'
      line: 'PASS_WARN_AGE 14'
    - regexp: '^PASS_MIN_LEN'
      line: 'PASS_MIN_LEN 12'
  tags: password_policy

# =================== CONFIGURACIÃ“N SSH ESPECÃFICA POR USUARIO ===================

- name: "ğŸ”‘ Crear directorio .ssh para usuarios del laboratorio"
  become: yes
  ansible.builtin.file:
    path: "/home/{{ item }}/.ssh"
    state: directory
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: '0700'
  loop:
    - lab_admin
    - lab_operator
    - lab_developer
  tags: ssh_config

# =================== CONFIGURACIÃ“N ADICIONAL DE SEGURIDAD ===================

- name: "ğŸ” Configurar lÃ­mites de recursos por usuario"
  become: yes
  ansible.builtin.copy:
    dest: /etc/security/limits.d/lab-users.conf
    content: |
      # LÃ­mites de recursos para usuarios del laboratorio
      
      # Administradores - sin lÃ­mites especiales
      @admin_users soft nproc 4096
      @admin_users hard nproc 8192
      
      # Operadores - lÃ­mites moderados
      @operators soft nproc 2048
      @operators hard nproc 4096
      @operators soft fsize 1048576
      @operators hard fsize 2097152
      
      # Desarrolladores - acceso a mÃ¡s procesos
      @developers soft nproc 3072
      @developers hard nproc 6144
      
      # Usuarios de backup - lÃ­mites de archivos grandes
      @backup_users soft fsize 10485760
      @backup_users hard fsize 20971520
      
      # AuditorÃ­a - lÃ­mites restrictivos
      @audit_users soft nproc 512
      @audit_users hard nproc 1024
      @audit_users soft fsize 102400
      @audit_users hard fsize 204800
    mode: '0644'
  tags: limits

- name: "ğŸ“Š Crear script de reporte de usuarios"
  become: yes
  ansible.builtin.copy:
    dest: /usr/local/bin/lab-users-report
    content: |
      #!/bin/bash
      # Script de reporte de usuarios del laboratorio
      
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "ğŸ“Š REPORTE DE USUARIOS Y PERMISOS DEL LABORATORIO"
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      echo "ğŸ“… Fecha: $(date)"
      echo ""
      
      echo "ğŸ‘¥ GRUPOS DEL SISTEMA:"
      echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
      getent group | grep -E "(admin_users|developers|operators|backup_users|audit_users)" | while IFS=: read group x gid members; do
        echo "  $group (GID: $gid) - Miembros: ${members:-'ninguno'}"
      done
      
      echo ""
      echo "ğŸ‘¤ USUARIOS DEL LABORATORIO:"
      echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
      getent passwd | grep -E "(lab_admin|lab_operator|lab_developer|lab_audit|lab_backup)" | while IFS=: read user x uid gid gecos home shell; do
        groups=$(groups $user 2>/dev/null | cut -d: -f2)
        echo "  $user (UID: $uid, GID: $gid) - $gecos"
        echo "    Grupos: $groups"
        echo "    Home: $home, Shell: $shell"
        echo ""
      done
      
      echo "ğŸ“ DIRECTORIOS COMPARTIDOS:"
      echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
      for dir in /home/shared/*; do
        if [ -d "$dir" ]; then
          perms=$(ls -ld "$dir" | awk '{print $1, $3, $4}')
          echo "  $dir - $perms"
        fi
      done
      
      echo ""
      echo "âš–ï¸ CONFIGURACIÃ“N SUDO:"
      echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
      if [ -f /etc/sudoers.d/lab-users ]; then
        echo "  âœ… Archivo de configuraciÃ³n sudo presente"
        echo "  ğŸ“Š Grupos con privilegios sudo:"
        grep -E "^%" /etc/sudoers.d/lab-users | awk '{print "    " $1}'
      else
        echo "  âŒ No se encontrÃ³ configuraciÃ³n sudo especÃ­fica"
      fi
      
      echo ""
      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    mode: '0755'
  tags: reporting

- name: "ğŸ“ Crear logs de gestiÃ³n de usuarios"
  become: yes
  ansible.builtin.file:
    path: /var/log/lab-users
    state: directory
    owner: root
    group: admin_users
    mode: '0750'
  tags: logging
