---
# üìå Rol: Administraci√≥n avanzada de usuarios, permisos y pol√≠ticas

# ‚úÖ 1. Instalar herramientas de gesti√≥n de usuarios (Fedora/CentOS)
- name: Instalar herramientas de gesti√≥n de usuarios en Fedora/CentOS
  become: yes
  ansible.builtin.package:
    name:
      - sudo
      - passwd
      - libpwquality  # En Fedora se llama libpwquality
      - shadow-utils
    state: present
  when: ansible_facts['os_family'] == "RedHat"
  ignore_errors: yes

# ‚úÖ 1b. Instalar herramientas de gesti√≥n de usuarios (Ubuntu/Mint)
- name: Instalar herramientas de gesti√≥n de usuarios en Ubuntu/Mint
  become: yes
  ansible.builtin.package:
    name:
      - sudo
      - passwd
      - libpam-pwquality  # En Ubuntu se llama libpam-pwquality
      # shadow-utils no existe en Ubuntu/Mint - se omite
    state: present
  when: ansible_facts['os_family'] == "Debian"
  ignore_errors: yes

# ‚úÖ 2. Configurar pol√≠ticas de contrase√±a
- name: Configurar pol√≠tica de contrase√±as seguras (solo Ubuntu/Mint)
  become: yes
  ansible.builtin.lineinfile:
    path: /etc/pam.d/common-password
    regexp: '^password.*pam_pwquality.so'
    line: 'password requisite pam_pwquality.so retry=3 minlen={{ password_policy.min_length | default(8) }} dcredit=-1 ucredit=-1 ocredit=-1 lcredit=-1'
    backup: yes
    create: yes
  when: 
    - ansible_facts['os_family'] == "Debian"
    - password_policy is defined
  ignore_errors: yes

# ‚úÖ 3. Configurar expiraci√≥n de contrase√±as
- name: Configurar expiraci√≥n de contrase√±as
  become: yes
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^PASS_MAX_DAYS'
    line: 'PASS_MAX_DAYS {{ password_policy.max_age_days | default(90) }}'
    backup: yes
  when: password_policy is defined

# ‚úÖ 4. Crear grupos del sistema
- name: Crear grupos necesarios
  become: yes
  ansible.builtin.group:
    name: "{{ item }}"
    state: present
  loop: "{{ user_groups | default(['docentes', 'soporte', 'laboratorio']) }}"

# ‚úÖ 5. Crear usuarios con configuraci√≥n avanzada
- name: Crear usuarios del laboratorio
  become: yes
  ansible.builtin.user:
    name: "{{ item.name }}"
    state: present
    groups: "{{ item.group }}"
    shell: /bin/bash
    create_home: yes
    home: "{{ user_home_base | default('/home') }}/{{ item.name }}"
    password: "{{ lookup('vars', 'vault_password_' + item.name, default='*') }}"
  loop: "{{ lab_users | default([]) }}"
  no_log: true  # No mostrar contrase√±as en logs

# ‚úÖ 6. Configurar sudo para usuarios autorizados
- name: Configurar sudo sin contrase√±a para usuarios espec√≠ficos
  become: yes
  ansible.builtin.copy:
    dest: "/etc/sudoers.d/{{ item }}"
    content: "{{ item }} ALL=(ALL) NOPASSWD:ALL"
    owner: root
    group: root
    mode: '0440'
    validate: 'visudo -cf %s'
  loop: "{{ sudo_nopasswd_users | default(['adminlab']) }}"

# ‚úÖ 7. Configurar sudo limitado para otros usuarios
- name: Configurar sudo limitado para usuarios t√©cnicos
  become: yes
  ansible.builtin.copy:
    dest: /etc/sudoers.d/technical_users
    content: |
      # Permitir a usuarios t√©cnicos comandos espec√≠ficos
      %soporte ALL=(ALL) NOPASSWD: /bin/systemctl restart *, /bin/systemctl stop *, /bin/systemctl start *
      %soporte ALL=(ALL) NOPASSWD: /usr/bin/tail /var/log/*, /usr/bin/less /var/log/*
      %docentes ALL=(ALL) NOPASSWD: /bin/ps *, /usr/bin/top, /usr/bin/htop
    owner: root
    group: root
    mode: '0440'
    validate: 'visudo -cf %s'

# ‚úÖ 8. Configurar permisos correctos en directorios home
- name: Asegurar permisos correctos en directorios home
  become: yes
  ansible.builtin.file:
    path: "{{ user_home_base | default('/home') }}/{{ item.name }}"
    owner: "{{ item.name }}"
    group: "{{ item.group }}"
    mode: '0750'
    state: directory
    recurse: no  # Solo el directorio principal, no todo el contenido
  loop: "{{ lab_users | default([]) }}"

# ‚úÖ 9. Crear directorio de logs para auditor√≠a de usuarios
- name: Crear directorio de auditor√≠a
  become: yes
  ansible.builtin.file:
    path: /var/log/user_audit
    state: directory
    owner: root
    group: root
    mode: '0750'

# ‚úÖ 10. Configurar logging de comandos sudo
- name: Configurar logging de comandos sudo
  become: yes
  ansible.builtin.lineinfile:
    path: /etc/sudoers
    line: 'Defaults logfile="/var/log/user_audit/sudo.log"'
    validate: 'visudo -cf %s'
    backup: yes

# ‚úÖ 11. Crear script de auditor√≠a de usuarios
- name: Crear script de auditor√≠a de usuarios
  become: yes
  ansible.builtin.copy:
    dest: /usr/local/bin/user_audit.sh
    content: |
      #!/bin/bash
      # Script de auditor√≠a de usuarios
      
      AUDIT_LOG="/var/log/user_audit/user_report.log"
      echo "=== Auditor√≠a de Usuarios $(date) ===" > "$AUDIT_LOG"
      
      # Usuarios conectados
      echo "--- Usuarios Conectados ---" >> "$AUDIT_LOG"
      who >> "$AUDIT_LOG"
      
      # √öltimos logins
      echo "--- √öltimos Logins ---" >> "$AUDIT_LOG"
      last -n 20 >> "$AUDIT_LOG"
      
      # Usuarios con sudo
      echo "--- Usuarios con Privilegios Sudo ---" >> "$AUDIT_LOG"
      grep -r "^[^#].*ALL=" /etc/sudoers.d/ /etc/sudoers 2>/dev/null >> "$AUDIT_LOG"
      
      # Verificar integridad de archivos cr√≠ticos
      echo "--- Verificaci√≥n de Archivos Cr√≠ticos ---" >> "$AUDIT_LOG"
      ls -la /etc/passwd /etc/shadow /etc/group /etc/sudoers >> "$AUDIT_LOG"
      
      echo "=== Fin de Auditor√≠a ===" >> "$AUDIT_LOG"
    owner: root
    group: root
    mode: '0755'

# ‚úÖ 12. Programar auditor√≠a diaria
- name: Programar auditor√≠a diaria de usuarios
  become: yes
  ansible.builtin.cron:
    name: "Auditor√≠a diaria de usuarios"
    minute: "0"
    hour: "7"
    job: "/usr/local/bin/user_audit.sh"
    user: root

# ‚úÖ 13. Verificar usuarios existentes y mostrar estado
- name: Verificar usuarios creados
  become: yes
  ansible.builtin.command: "getent passwd {{ item.name }}"
  register: user_check
  loop: "{{ lab_users | default([]) }}"
  failed_when: false
  changed_when: false

- name: Mostrar estado de usuarios
  ansible.builtin.debug:
    msg: "Usuario {{ item.item.name }}: {{ 'EXISTE' if item.rc == 0 else 'NO EXISTE' }}"
  loop: "{{ user_check.results }}"
