---
# üìå Rol: Automatizaci√≥n de tareas avanzada

# ‚úÖ 1. Instalar herramientas necesarias para automatizaci√≥n
- name: Instalar herramientas de automatizaci√≥n
  become: yes
  ansible.builtin.package:
    name:
      - cron
      - logrotate
      - rsync
      - mailutils
    state: present

# ‚úÖ 2. Configurar actualizaci√≥n autom√°tica del sistema
- name: Configurar actualizaci√≥n autom√°tica
  become: yes
  ansible.builtin.cron:
    name: "{{ item.name }}"
    minute: "{{ item.minute }}"
    hour: "{{ item.hour }}"
    weekday: "{{ item.weekday | default('*') }}"
    job: "{{ item.job }}"
    user: "{{ automation_user | default('root') }}"
  loop:
    - name: "Actualizaci√≥n autom√°tica del sistema"
      minute: "{{ auto_update_schedule.minute | default('0') }}"
      hour: "{{ auto_update_schedule.hour | default('2') }}"
      weekday: "{{ auto_update_schedule.weekday | default('0') }}"
      job: "apt update && apt upgrade -y >> /var/log/auto-update.log 2>&1"
  when: auto_update_enabled | default(false)

# ‚úÖ 3. Configurar backup autom√°tico avanzado
- name: Crear directorio de backup
  become: yes
  ansible.builtin.file:
    path: "{{ backup_directory }}"
    state: directory
    owner: root
    group: root
    mode: '0750'
  when: backup_enabled | default(false)

- name: Configurar backup autom√°tico con rotaci√≥n
  become: yes
  ansible.builtin.cron:
    name: "Backup autom√°tico con rotaci√≥n"
    minute: "{{ backup_schedule.minute | default('0') }}"
    hour: "{{ backup_schedule.hour | default('2') }}"
    job: >-
      tar -czf {{ backup_directory }}/logs_$(date +\%F).tar.gz /var/log &&
      find {{ backup_directory }} -name "logs_*.tar.gz" -mtime +{{ backup_retention_days | default(7) }} -delete
    user: "{{ automation_user | default('root') }}"
  when: backup_enabled | default(false)

# ‚úÖ 4. Configurar limpieza autom√°tica avanzada
- name: Configurar limpieza de archivos temporales
  become: yes
  ansible.builtin.cron:
    name: "Limpieza autom√°tica - {{ item }}"
    minute: "{{ cleanup_schedule.minute | default('0') }}"
    hour: "{{ cleanup_schedule.hour | default('3') }}"
    weekday: "{{ cleanup_schedule.weekday | default('0') }}"
    job: "find {{ item }} -type f -atime +1 -delete 2>/dev/null || true"
    user: "{{ automation_user | default('root') }}"
  loop: "{{ cleanup_paths }}"
  when: cleanup_enabled | default(false)

# ‚úÖ 5. Configurar rotaci√≥n avanzada de logs
- name: Configurar rotaci√≥n de logs del sistema
  become: yes
  ansible.builtin.copy:
    dest: /etc/logrotate.d/lab-system
    content: |
      /var/log/*.log {
          rotate {{ log_rotate_count | default(5) }}
          size {{ log_max_size | default('100M') }}
          compress
          delaycompress
          missingok
          notifempty
          create 644 root root
      }
    owner: root
    group: root
    mode: '0644'
  when: log_rotation_enabled | default(false)

# ‚úÖ 6. Crear script de monitoreo de servicios cr√≠ticos
- name: Crear script de monitoreo de servicios
  become: yes
  ansible.builtin.copy:
    dest: /usr/local/bin/check_services.sh
    content: |
      #!/bin/bash
      # Script de monitoreo de servicios cr√≠ticos
      
      SERVICES=(ssh cron systemd-logind)
      ALERT_LOG="/var/log/service_alerts.log"
      
      for service in "${SERVICES[@]}"; do
          if ! systemctl is-active --quiet "$service"; then
              echo "[$(date)] ALERT: Servicio $service no est√° activo" >> "$ALERT_LOG"
              logger "ALERT: Servicio $service no est√° activo"
              # Intentar reiniciar el servicio
              systemctl restart "$service"
              if systemctl is-active --quiet "$service"; then
                  echo "[$(date)] INFO: Servicio $service reiniciado exitosamente" >> "$ALERT_LOG"
              fi
          fi
      done
    owner: root
    group: root
    mode: '0755'

# ‚úÖ 7. Programar monitoreo de servicios cada 5 minutos
- name: Programar monitoreo de servicios cr√≠ticos
  become: yes
  ansible.builtin.cron:
    name: "Monitoreo de servicios cr√≠ticos"
    minute: "*/5"
    job: "/usr/local/bin/check_services.sh"
    user: root

# ‚úÖ 8. Configurar alertas por email si est√° habilitado
- name: Configurar alertas por email
  become: yes
  ansible.builtin.cron:
    name: "Resumen diario de alertas"
    minute: "0"
    hour: "8"
    job: >-
      if [ -f /var/log/service_alerts.log ]; then
        cat /var/log/service_alerts.log | mail -s "Resumen de alertas - $(hostname)" {{ admin_email }};
        > /var/log/service_alerts.log;
      fi
    user: root
  when: 
    - email_alerts_enabled | default(false)
    - admin_email is defined

# ‚úÖ 9. Crear tarea de validaci√≥n diaria del sistema
- name: Crear script de validaci√≥n diaria
  become: yes
  ansible.builtin.copy:
    dest: /usr/local/bin/daily_validation.sh
    content: |
      #!/bin/bash
      # Validaci√≥n diaria del sistema
      
      REPORT="/var/log/daily_report.log"
      echo "=== Reporte Diario del Sistema $(date) ===" > "$REPORT"
      
      # Estado de servicios
      echo "--- Servicios ---" >> "$REPORT"
      systemctl --failed --no-legend >> "$REPORT"
      
      # Uso de disco
      echo "--- Uso de Disco ---" >> "$REPORT"
      df -h >> "$REPORT"
      
      # Carga del sistema
      echo "--- Carga del Sistema ---" >> "$REPORT"
      uptime >> "$REPORT"
      
      # Top procesos por CPU
      echo "--- Top Procesos CPU ---" >> "$REPORT"
      ps aux --sort=-%cpu | head -10 >> "$REPORT"
      
      # Top procesos por memoria
      echo "--- Top Procesos Memoria ---" >> "$REPORT"
      ps aux --sort=-%mem | head -10 >> "$REPORT"
      
      echo "=== Fin del Reporte ===" >> "$REPORT"
    owner: root
    group: root
    mode: '0755'

# ‚úÖ 10. Programar validaci√≥n diaria
- name: Programar validaci√≥n diaria del sistema
  become: yes
  ansible.builtin.cron:
    name: "Validaci√≥n diaria del sistema"
    minute: "30"
    hour: "6"
    job: "/usr/local/bin/daily_validation.sh"
    user: root
