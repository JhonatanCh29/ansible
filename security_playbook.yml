---
# ğŸ“Š Playbook Principal de Seguridad - Cumplimiento AcadÃ©mico Nivel 4

- name: "ğŸ”’ LABORATORIO DE SEGURIDAD - ImplementaciÃ³n Completa"
  hosts: all
  become: yes
  gather_facts: yes
  
  vars_files:
    - group_vars/all/security.yml
  
  pre_tasks:
    - name: "ğŸ“‹ Verificar sistema operativo soportado"
      ansible.builtin.assert:
        that:
          - ansible_facts['os_family'] == "Debian" or ansible_facts['os_family'] == "RedHat"
        fail_msg: "âŒ Sistema operativo no soportado: {{ ansible_facts['os_family'] }}"
        success_msg: "âœ… Sistema operativo soportado: {{ ansible_facts['os_family'] }}"
    
    - name: "ğŸ” Mostrar informaciÃ³n del sistema"
      ansible.builtin.debug:
        msg:
          - "ğŸ–¥ï¸  Sistema: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}"
          - "ğŸ—ï¸  Arquitectura: {{ ansible_facts['architecture'] }}"
          - "ğŸ’¾ Memoria: {{ (ansible_facts['memtotal_mb']/1024)|round(1) }}GB"
          - "ğŸ’¿ Espacio: {{ (ansible_facts['devices']['sda']['size']|default('N/A')) }}"

  roles:
    # ğŸ”¥ 1. PROTECCIÃ“N BÃSICA - Firewall y reglas de red
    - role: firewall
      tags: ['firewall', 'network', 'basic']
      vars:
        firewall_enabled: true
        firewall_default_policy: 'deny'
    
    # ğŸ¦  2. SEGURIDAD LOCAL - Antivirus y detecciÃ³n de amenazas
    - role: seguridad_local
      tags: ['antivirus', 'security', 'scanning']
      vars:
        enable_clamav: true
        enable_rkhunter: true
        schedule_daily_scans: true
    
    # ğŸ›¡ï¸ 3. PROTECCIÃ“N CONTRA AMENAZAS - IDS/IPS y monitoreo
    - role: proteccion_amenazas
      tags: ['ids', 'ips', 'monitoring', 'threats']
      vars:
        enable_fail2ban: true
        enable_aide: true
        enable_auditd: true
        enable_process_monitor: true
    
    # ğŸ‘¤ 4. GESTIÃ“N AVANZADA DE USUARIOS - PolÃ­ticas y restricciones
    - role: practicas_seguras_usuario
      tags: ['users', 'policies', 'restrictions']
      vars:
        session_timeout: 900
        max_login_attempts: 3
        restrict_ssh_access: true
    
    # ğŸ‘¥ 5. GESTIÃ“N AVANZADA DE USUARIOS - CreaciÃ³n y configuraciÃ³n completa
    - role: usuarios_permisos
      tags: ['users', 'permissions', 'management', 'groups']
      vars:
        password_policy:
          min_length: 12
          max_age_days: 90
          require_complex: true

  post_tasks:
    # ğŸ“Š VerificaciÃ³n del estado de seguridad
    - name: "ğŸ” Verificar servicios de seguridad activos"
      ansible.builtin.service_facts:
      
    - name: "âœ… Mostrar estado de servicios crÃ­ticos"
      ansible.builtin.debug:
        msg: |
          ğŸ”’ ESTADO DE SEGURIDAD DEL SISTEMA:
          
          ğŸ¦  ClamAV: {{ 'ACTIVO' if services['clamav-daemon.service']['state'] == 'running' else 'INACTIVO' }}
          ğŸ›¡ï¸ Fail2Ban: {{ 'ACTIVO' if services['fail2ban.service']['state'] == 'running' else 'INACTIVO' }}
          ğŸ“‹ Auditd: {{ 'ACTIVO' if services['auditd.service']['state'] == 'running' else 'INACTIVO' }}
          ğŸ”¥ UFW: {{ 'ACTIVO' if services['ufw.service']['state'] == 'running' else 'INACTIVO' }}
          ğŸ” SSH: {{ 'ACTIVO' if services['sshd.service']['state'] == 'running' or services['ssh.service']['state'] == 'running' else 'INACTIVO' }}
      ignore_errors: yes

    # ğŸ“ Crear reporte de cumplimiento
    - name: "ğŸ“Š Crear directorio de reportes"
      ansible.builtin.file:
        path: /var/log/security-compliance
        state: directory
        mode: '0755'
      
    - name: "ğŸ“‹ Generar reporte de cumplimiento acadÃ©mico"
      ansible.builtin.template:
        src: templates/compliance_report.j2
        dest: "/var/log/security-compliance/compliance-{{ ansible_date_time.date }}.txt"
        mode: '0644'
      vars:
        timestamp: "{{ ansible_date_time.iso8601 }}"
        hostname: "{{ ansible_hostname }}"
    
    # ğŸ¯ Mensaje final de estado
    - name: "ğŸ‰ IMPLEMENTACIÃ“N COMPLETADA"
      ansible.builtin.debug:
        msg: |
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ† LABORATORIO DE SEGURIDAD - NIVEL 4 IMPLEMENTADO
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âœ… COMPONENTES INSTALADOS:
          
          ğŸ”¥ Firewall configurado con polÃ­ticas restrictivas
          ğŸ¦  Antivirus ClamAV con escaneos automÃ¡ticos
          ğŸ›¡ï¸ IDS/IPS Fail2Ban contra ataques de fuerza bruta
          ğŸ“‹ Sistema de auditorÃ­a AUDITD para monitoreo
          ğŸ” AIDE para integridad de archivos crÃ­ticos
          ğŸ‘¤ PolÃ­ticas avanzadas de usuario y sesiÃ³n
          ğŸ“Š Monitoreo de procesos y actividad del sistema
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ“Š CUMPLIMIENTO ACADÃ‰MICO:
          
          ğŸ“š Unidad 2: âœ… Nivel 4 - ConfiguraciÃ³n de red avanzada
          ğŸ”’ Unidad 3: âœ… Nivel 4 - Seguridad integral del sistema
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ“ Reportes disponibles en: /var/log/security-compliance/
          ğŸ”§ ConfiguraciÃ³n en: /home/jhonatan/ansible/
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•