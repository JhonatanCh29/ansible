---
# ğŸ‘¥ Playbook EspecÃ­fico para GestiÃ³n Avanzada de Usuarios y Permisos

- name: "ğŸ‘¥ LABORATORIO - ImplementaciÃ³n de GestiÃ³n de Usuarios Nivel 4"
  hosts: all
  become: yes
  gather_facts: yes
  
  vars_files:
    - group_vars/all/security.yml
  
  pre_tasks:
    - name: "ğŸ“‹ Verificar sistema operativo compatible"
      ansible.builtin.assert:
        that:
          - ansible_facts['os_family'] == "Debian" or ansible_facts['os_family'] == "RedHat"
        fail_msg: "âŒ Sistema no compatible: {{ ansible_facts['os_family'] }}"
        success_msg: "âœ… Sistema compatible: {{ ansible_facts['os_family'] }}"
    
    - name: "ğŸ–¥ï¸ Mostrar informaciÃ³n del sistema"
      ansible.builtin.debug:
        msg:
          - "ğŸ—ï¸ Sistema: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}"
          - "ğŸ”§ Arquitectura: {{ ansible_facts['architecture'] }}"
          - "ğŸ‘¤ Usuario actual: {{ ansible_user }}"
          - "ğŸ  Directorio home: {{ ansible_env.HOME }}"

  roles:
    # ğŸ‘¤ GestiÃ³n completa de usuarios, grupos y permisos
    - role: usuarios_permisos
      tags: ['users', 'groups', 'permissions', 'management']

  post_tasks:
    # ğŸ” VerificaciÃ³n de la implementaciÃ³n
    - name: "ğŸ” Verificar grupos creados"
      ansible.builtin.command: getent group {{ item }}
      register: group_check
      loop:
        - admin_users
        - developers
        - operators
        - backup_users
        - audit_users
      failed_when: group_check.rc != 0
      changed_when: false
    
    - name: "ğŸ‘¤ Verificar usuarios creados"
      ansible.builtin.command: id {{ item }}
      register: user_check
      loop:
        - lab_admin
        - lab_operator
        - lab_developer
        - lab_audit
        - lab_backup
      failed_when: user_check.rc != 0
      changed_when: false
    
    - name: "ğŸ“ Verificar directorios compartidos"
      ansible.builtin.stat:
        path: "{{ item }}"
      register: dir_check
      loop:
        - /home/shared/admin
        - /home/shared/development
        - /home/shared/operations
        - /home/shared/backups
        - /home/shared/audit
      failed_when: not dir_check.stat.exists or not dir_check.stat.isdir
    
    - name: "ğŸ” Verificar configuraciÃ³n sudo"
      ansible.builtin.stat:
        path: /etc/sudoers.d/lab-users
      register: sudo_config
      failed_when: not sudo_config.stat.exists
    
    - name: "ğŸ“Š Generar reporte de usuarios implementados"
      ansible.builtin.template:
        src: users_report.j2
        dest: "/var/log/lab-users/implementation-{{ ansible_date_time.date }}.txt"
        mode: '0644'
      vars:
        implementation_date: "{{ ansible_date_time.iso8601 }}"
        hostname: "{{ ansible_hostname }}"
        groups_created: "{{ group_check.results | length }}"
        users_created: "{{ user_check.results | length }}"
        directories_created: "{{ dir_check.results | length }}"
    
    # ğŸ‰ Mensaje final de Ã©xito
    - name: "ğŸ‰ GESTIÃ“N DE USUARIOS COMPLETADA"
      ansible.builtin.debug:
        msg: |
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ† GESTIÃ“N DE USUARIOS - NIVEL 4 IMPLEMENTADO EXITOSAMENTE
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âœ… COMPONENTES IMPLEMENTADOS:
          
          ğŸ‘¥ 5 Grupos funcionales creados (admin_users, developers, etc.)
          ğŸ‘¤ 5 Usuarios especializados configurados (lab_admin, lab_operator, etc.)
          ğŸ“ 5 Directorios compartidos con permisos especÃ­ficos
          ğŸ” ConfiguraciÃ³n sudo avanzada por grupos
          ğŸ”’ PolÃ­ticas robustas de contraseÃ±as (12+ caracteres)
          âš–ï¸ LÃ­mites de recursos configurados por usuario
          ğŸ“Š Herramientas de reporte y monitoreo
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ“‹ CUMPLIMIENTO ACADÃ‰MICO VERIFICADO:
          
          ğŸ¯ Nivel 4: âœ… GestiÃ³n avanzada de usuarios y permisos
          ğŸ‘¥ Grupos funcionales: âœ… Implementados con GIDs especÃ­ficos
          ğŸ” Seguridad: âœ… PolÃ­ticas y privilegios diferenciados
          ğŸ“ Estructura: âœ… Directorios compartidos organizados
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ”§ COMANDOS DE VERIFICACIÃ“N:
          
          Ver usuarios:    getent passwd | grep lab_
          Ver grupos:      getent group | grep -E "(admin_users|developers)"
          Reporte:         sudo /usr/local/bin/lab-users-report
          Directorios:     ls -la /home/shared/
          ConfiguraciÃ³n:   sudo cat /etc/sudoers.d/lab-users
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸš€ Sistema listo para demostraciÃ³n acadÃ©mica de gestiÃ³n de usuarios
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•