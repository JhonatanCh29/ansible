---
# Playbook to bootstrap the control node (run on the control machine)
# Usage:
#   ansible-playbook -c local playbooks/bootstrap_control.yml --ask-become-pass

- name: Bootstrap control node
  hosts: localhost
  connection: local
  gather_facts: yes
  become: true
  tasks:
    - name: Ensure apt cache is updated
      ansible.builtin.apt:
        update_cache: yes

    - name: Install system packages
      ansible.builtin.apt:
        name:
          - python3
          - python3-venv
          - python3-pip
          - git
          - ansible
          - sshpass
          - vim
        state: present
        install_recommends: no

    - name: Install python user packages (ansible-lint, yamllint)
      ansible.builtin.pip:
        name:
          - ansible-lint
          - yamllint
        executable: pip3
        state: present

    - name: Ensure ~/.ssh exists
      ansible.builtin.file:
        path: "{{ lookup('env','HOME') }}/.ssh"
        state: directory
        mode: '0700'

    - name: Generate an SSH keypair if missing
      ansible.builtin.openssh_keypair:
        path: "{{ lookup('env','HOME') }}/.ssh/id_ed25519"
        type: ed25519
        force: no

    - name: Configure passwordless sudo for 'control' user (NOPASSWD)
      ansible.builtin.copy:
        dest: /etc/sudoers.d/control-nopasswd
        content: "control ALL=(ALL) NOPASSWD:ALL\n"
        owner: root
        group: root
        mode: '0440'

    - name: Show next steps message
      ansible.builtin.debug:
        msg: |
          Bootstrap finished. Copy the public key (~/.ssh/id_ed25519.pub) to your lab hosts
          and then run the lab playbooks, for example:
            ansible-playbook -i inventory/hosts.yml playbooks/setup_network_server.yml
