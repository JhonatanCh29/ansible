---
# Playbook to bootstrap the control node (run on the control machine)
# Usage:
#   ansible-playbook -c local playbooks/bootstrap_control.yml --ask-become-pass

- name: Bootstrap control node
  hosts: localhost
  connection: local
  gather_facts: yes
  # Do not use global become here; escalate only on tasks that need root
  tasks:
    - name: Ensure apt cache is updated
      ansible.builtin.apt:
        update_cache: yes
      become: true

    - name: Install system packages
      ansible.builtin.apt:
        name:
          - python3
          - python3-venv
          - python3-pip
          - git
          - ansible
          - sshpass
          - vim
        state: present
        install_recommends: no
      become: true

    - name: Set control user and venv path
      ansible.builtin.set_fact:
        control_user: control
        venv_path: "/home/control/.ansible-venv"

    - name: Ensure 'control' user exists
      ansible.builtin.user:
        name: control
        comment: "Ansible control user"
        create_home: yes
        shell: /bin/bash
        state: present
      become: true

    - name: Create python virtualenv for control user
      ansible.builtin.command:
        cmd: python3 -m venv {{ venv_path }}
        creates: "{{ venv_path }}/bin/activate"
      become: true
      become_user: control

    - name: Install python packages (ansible-core, ansible-lint, yamllint) into the venv
      ansible.builtin.pip:
        name:
          - ansible-core
          - ansible-lint
          - yamllint
        virtualenv: "{{ venv_path }}"
      become: true
      become_user: control

    - name: Install common Ansible collections (community.general, ansible.posix, community.crypto) into the user's environment
      ansible.builtin.command:
        cmd: "{{ venv_path }}/bin/ansible-galaxy collection install community.general ansible.posix community.crypto"
      become: true
      become_user: control

    - name: Ensure venv ownership is control user
      ansible.builtin.file:
        path: "{{ venv_path }}"
        owner: "{{ control_user }}"
        group: "{{ control_user }}"
        recurse: yes
      become: true

    - name: Ensure control user's ~/.ssh exists
      ansible.builtin.file:
        path: "/home/control/.ssh"
        state: directory
        owner: control
        group: control
        mode: '0700'
      become: true

    - name: Ensure control user's .ssh directory exists
      ansible.builtin.file:
        path: "/home/control/.ssh"
        state: directory
        mode: '0700'

    - name: Check if control private key exists
      ansible.builtin.stat:
        path: /home/control/.ssh/id_ed25519
      register: control_key_stat

    - name: Generate an SSH keypair for control user if missing (ssh-keygen)
      ansible.builtin.command:
        cmd: ssh-keygen -t ed25519 -f /home/control/.ssh/id_ed25519 -N '' -C 'control@lab'
        creates: /home/control/.ssh/id_ed25519
      become: true
      become_user: control

    - name: Ensure key file ownership and permissions are correct
      ansible.builtin.file:
        path: /home/control/.ssh/id_ed25519
        owner: control
        group: control
        mode: '0600'
      become: true
      when: control_key_stat.stat.exists

    - name: Configure passwordless sudo for 'control' user (NOPASSWD)
      ansible.builtin.copy:
        dest: /etc/sudoers.d/control-nopasswd
        content: "control ALL=(ALL) NOPASSWD:ALL\n"
        owner: root
        group: root
        mode: '0440'
      become: true

    - name: Show next steps message
      ansible.builtin.debug:
        msg: |
          Bootstrap finished. Copy the public key (~/.ssh/id_ed25519.pub) to your lab hosts
          and then run the lab playbooks, for example:
            ansible-playbook -i inventory/hosts.yml playbooks/setup_network_server.yml
