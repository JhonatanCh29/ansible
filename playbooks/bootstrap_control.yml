---
# Playbook to bootstrap the control node (run on the control machine)
# Usage:
#   ansible-playbook -c local playbooks/bootstrap_control.yml --ask-become-pass

- name: Bootstrap control node
  hosts: localhost
  connection: local
  gather_facts: yes
  become: true
  tasks:
    - name: Ensure apt cache is updated
      ansible.builtin.apt:
        update_cache: yes

    - name: Install system packages
      ansible.builtin.apt:
        name:
          - python3
          - python3-venv
          - python3-pip
          - git
          - ansible
          - sshpass
          - vim
        state: present
        install_recommends: no

    - name: Set control user and venv path
      ansible.builtin.set_fact:
        control_user: control
        venv_path: "/home/control/.ansible-venv"

    - name: Create python virtualenv for control user
      ansible.builtin.command:
        cmd: python3 -m venv {{ venv_path }}
        creates: "{{ venv_path }}/bin/activate"
      become: true
      become_user: root

    - name: Install python packages (ansible-core, ansible-lint, yamllint) into the venv
      ansible.builtin.pip:
        name:
          - ansible-core
          - ansible-lint
          - yamllint
        virtualenv: "{{ venv_path }}"
      become: true
      become_user: root

    - name: Install common Ansible collections (community.general, ansible.posix) into the user's environment
      ansible.builtin.command:
        cmd: "{{ venv_path }}/bin/ansible-galaxy collection install community.general ansible.posix"
      become: true
      become_user: root

    - name: Ensure venv ownership is control user
      ansible.builtin.file:
        path: "{{ venv_path }}"
        owner: "{{ control_user }}"
        group: "{{ control_user }}"
        recurse: yes

    - name: Ensure ~/.ssh exists
      ansible.builtin.file:
        path: "{{ lookup('env','HOME') }}/.ssh"
        state: directory
        mode: '0700'

    - name: Generate an SSH keypair if missing
      ansible.builtin.openssh_keypair:
        path: "{{ lookup('env','HOME') }}/.ssh/id_ed25519"
        type: ed25519
        force: no

    - name: Configure passwordless sudo for 'control' user (NOPASSWD)
      ansible.builtin.copy:
        dest: /etc/sudoers.d/control-nopasswd
        content: "control ALL=(ALL) NOPASSWD:ALL\n"
        owner: root
        group: root
        mode: '0440'

    - name: Show next steps message
      ansible.builtin.debug:
        msg: |
          Bootstrap finished. Copy the public key (~/.ssh/id_ed25519.pub) to your lab hosts
          and then run the lab playbooks, for example:
            ansible-playbook -i inventory/hosts.yml playbooks/setup_network_server.yml
