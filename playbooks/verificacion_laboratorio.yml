---
# Playbook de verificaci√≥n y monitoreo del laboratorio
# Este playbook valida que todos los componentes cr√≠ticos est√©n funcionando

- name: üîç Verificaci√≥n completa del laboratorio
  hosts: all
  become: yes
  gather_facts: yes
  
  vars:
    critical_services:
      - ssh
      - cron
      - systemd-logind
    network_services:
      - dnsmasq
    disk_usage_threshold: 85
    memory_usage_threshold: 85

  tasks:
    # ===== VERIFICACIONES DE SISTEMA =====
    - name: ‚úÖ Verificar servicios cr√≠ticos
      ansible.builtin.systemd:
        name: "{{ item }}"
      register: service_status
      loop: "{{ critical_services }}"
      failed_when: service_status.status.ActiveState != 'active'
      
    - name: üìä Verificar uso de disco
      ansible.builtin.shell: "df / | awk 'NR==2 {print $5}' | sed 's/%//'"
      register: disk_usage
      changed_when: false
      
    - name: ‚ö†Ô∏è Alertar si uso de disco es alto
      ansible.builtin.fail:
        msg: "CR√çTICO: Uso de disco en / es {{ disk_usage.stdout }}% (umbral: {{ disk_usage_threshold }}%)"
      when: disk_usage.stdout | int > disk_usage_threshold
      
    - name: üß† Verificar uso de memoria
      ansible.builtin.shell: "free | awk 'NR==2{printf \"%.0f\", $3*100/$2 }'"
      register: memory_usage
      changed_when: false
      
    - name: ‚ö†Ô∏è Alertar si uso de memoria es alto
      ansible.builtin.debug:
        msg: "ADVERTENCIA: Uso de memoria es {{ memory_usage.stdout }}% (umbral: {{ memory_usage_threshold }}%)"
      when: memory_usage.stdout | int > memory_usage_threshold

    # ===== VERIFICACIONES DE RED (solo en vm_jhonatan) =====
    - name: üåê Verificar servicios de red
      ansible.builtin.systemd:
        name: "{{ item }}"
      register: network_service_status
      loop: "{{ network_services }}"
      failed_when: network_service_status.status.ActiveState != 'active'
      when: inventory_hostname == 'vm_jhonatan'
      
    - name: üîå Verificar conectividad a internet
      ansible.builtin.uri:
        url: "http://8.8.8.8:53"
        method: GET
        timeout: 5
      register: internet_check
      failed_when: false
      when: inventory_hostname == 'vm_jhonatan'
      
    - name: üì° Verificar DHCP est√° funcionando
      ansible.builtin.shell: "ps aux | grep dnsmasq | grep -v grep"
      register: dhcp_check
      changed_when: false
      when: inventory_hostname == 'vm_jhonatan'

    # ===== VERIFICACIONES DE SEGURIDAD =====
    - name: üîê Verificar configuraci√≥n de sudo
      ansible.builtin.stat:
        path: /etc/sudoers.d/adminlab
      register: sudo_config
      
    - name: üë• Verificar usuarios del laboratorio existen
      ansible.builtin.command: "id {{ item }}"
      register: user_check
      failed_when: user_check.rc != 0
      changed_when: false
      loop:
        - adminlab
        - tecnico1
        - profesor1
      ignore_errors: yes

    # ===== VERIFICACIONES DE ALMACENAMIENTO =====
    - name: üíæ Verificar scripts de backup existen
      ansible.builtin.stat:
        path: "{{ item }}"
      register: backup_scripts
      loop:
        - /usr/local/bin/backup_lab.sh
        - /usr/local/bin/disk_monitor.sh
      ignore_errors: yes
      
    - name: üìù Verificar configuraci√≥n de logrotate
      ansible.builtin.stat:
        path: /etc/logrotate.d/lab-logs
      register: logrotate_config
      ignore_errors: yes

    # ===== VERIFICACIONES DE AUTOMATIZACI√ìN =====
    - name: ‚è∞ Verificar tareas cron est√°n configuradas
      ansible.builtin.shell: "crontab -l | wc -l"
      register: cron_count
      changed_when: false
      become_user: root
      
    - name: üîß Verificar scripts de monitoreo existen
      ansible.builtin.stat:
        path: "{{ item }}"
      register: monitor_scripts
      loop:
        - /usr/local/bin/check_services.sh
        - /usr/local/bin/daily_validation.sh
        - /usr/local/bin/user_audit.sh
      ignore_errors: yes

    # ===== REPORTE FINAL =====
    - name: üìã Generar reporte de verificaci√≥n
      ansible.builtin.copy:
        dest: "/var/log/lab_verification_{{ ansible_date_time.date }}.log"
        content: |
          === REPORTE DE VERIFICACI√ìN DEL LABORATORIO ===
          Fecha: {{ ansible_date_time.date }} {{ ansible_date_time.time }}
          Host: {{ inventory_hostname }}
          
          === SERVICIOS CR√çTICOS ===
          {% for service in critical_services %}
          - {{ service }}: {{ 'OK' if service_status.results[loop.index0].status.ActiveState == 'active' else 'ERROR' }}
          {% endfor %}
          
          === RECURSOS DEL SISTEMA ===
          - Uso de disco: {{ disk_usage.stdout }}%
          - Uso de memoria: {{ memory_usage.stdout }}%
          - Uptime: {{ ansible_uptime_seconds // 3600 }} horas
          
          === SEGURIDAD ===
          - Configuraci√≥n sudo: {{ 'OK' if sudo_config.stat.exists else 'FALTA' }}
          - Usuarios laboratorio: {{ user_check.results | selectattr('rc', 'equalto', 0) | list | length }}/3 creados
          
          === ALMACENAMIENTO ===
          - Scripts backup: {{ backup_scripts.results | selectattr('stat.exists', 'defined') | selectattr('stat.exists') | list | length }}/{{ backup_scripts.results | length }}
          - Logrotate: {{ 'OK' if logrotate_config.stat.exists else 'NO CONFIGURADO' }}
          
          === AUTOMATIZACI√ìN ===
          - Tareas cron: {{ cron_count.stdout }}
          - Scripts monitoreo: {{ monitor_scripts.results | selectattr('stat.exists', 'defined') | selectattr('stat.exists') | list | length }}/{{ monitor_scripts.results | length }}
          
          {% if inventory_hostname == 'vm_jhonatan' %}
          === RED (Servidor) ===
          - DNSMASQ: {{ 'OK' if dhcp_check.stdout else 'ERROR' }}
          - Conectividad Internet: {{ 'OK' if internet_check.status == 200 else 'ERROR' }}
          {% endif %}
          
          === FIN DEL REPORTE ===
      
    - name: ‚úÖ Mostrar resumen de verificaci√≥n
      ansible.builtin.debug:
        msg: |
          üéØ VERIFICACI√ìN COMPLETADA PARA {{ inventory_hostname }}
          üìä Servicios cr√≠ticos: {{ critical_services | length }}/{{ critical_services | length }}
          üíæ Uso de disco: {{ disk_usage.stdout }}%
          üß† Uso de memoria: {{ memory_usage.stdout }}%
          üìã Reporte guardado en: /var/log/lab_verification_{{ ansible_date_time.date }}.log