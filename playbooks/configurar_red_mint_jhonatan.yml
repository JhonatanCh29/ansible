---
# Playbook para configurar red inicial en mint_jhonatan
# Ejecutar con: ansible-playbook -c local -i localhost, playbooks/configurar_red_mint_jhonatan.yml

- name: ğŸ’» ConfiguraciÃ³n inicial de red - mint_jhonatan (ejecutar EN mint_jhonatan)
  hosts: localhost
  become: yes
  connection: local
  gather_facts: yes
  
  vars:
    # Interfaz correcta segÃºn ip addr show
    lan_interface: "ens34"  # Interfaz para la red local del laboratorio
    
  tasks:
    - name: Mostrar interfaces disponibles
      ansible.builtin.command: ip link show
      register: interfaces
      changed_when: false
      
    - name: ğŸ“‹ Interfaces detectadas
      ansible.builtin.debug:
        var: interfaces.stdout_lines
        
    - name: ğŸ§¹ LIMPIAR COMPLETAMENTE la interfaz ens34
      ansible.builtin.shell: |
        # Bajar la interfaz
        ip link set ens34 down 2>/dev/null || true
        # Limpiar cualquier IP asignada
        ip addr flush dev ens34 2>/dev/null || true
        # Eliminar todas las conexiones de NetworkManager en ens34
        nmcli connection show | grep ens34 | awk '{print $1}' | xargs -r nmcli connection delete 2>/dev/null || true
        # Subir la interfaz limpia
        ip link set ens34 up 2>/dev/null || true
      register: cleanup_ens34
      
    - name: ğŸ“‹ Resultado de limpieza ens34
      ansible.builtin.debug:
        var: cleanup_ens34.stdout_lines
        
    - name: Detectar distribuciÃ³n
      ansible.builtin.set_fact:
        is_mint: "{{ 'mint' in ansible_distribution|lower or 'ubuntu' in ansible_distribution|lower }}"
        
    - name: Instalar NetworkManager si no estÃ¡ (Mint/Ubuntu)
      ansible.builtin.apt:
        name: network-manager
        state: present
        update_cache: yes
      when: is_mint
      
    - name: Asegurar NetworkManager estÃ¡ corriendo
      ansible.builtin.systemd:
        name: NetworkManager
        state: started
        enabled: yes
        
    - name: Eliminar conexiones existentes que puedan conflictuar
      ansible.builtin.command: nmcli connection delete "{{ item }}"
      loop:
        - "lan-dhcp"
        - "Wired connection 1"
        - "Wired connection 2"
      failed_when: false
      changed_when: false
      
    - name: ğŸŒ Configurar interfaz LAN para recibir DHCP
      ansible.builtin.command: >-
        nmcli connection add type ethernet 
        ifname {{ lan_interface }} 
        con-name lan-dhcp 
        ipv4.method auto 
        connection.autoconnect yes
      register: lan_config
      failed_when: lan_config.rc != 0 and 'already exists' not in lan_config.stderr
      
    - name: ğŸ”Œ Activar conexiÃ³n LAN
      ansible.builtin.command: nmcli connection up lan-dhcp
      register: lan_up
      failed_when: false
      
    - name: Esperar a que DHCP asigne IP
      ansible.builtin.wait_for:
        timeout: 15
        
    - name: ğŸ”„ Renovar DHCP si es necesario
      ansible.builtin.command: dhclient -r {{ lan_interface }} && dhclient {{ lan_interface }}
      failed_when: false
      
    - name: ğŸ“Š Verificar configuraciÃ³n de ens34
      ansible.builtin.command: ip addr show ens34
      register: ens34_config
      changed_when: false
      
    - name: ğŸ“‹ Mostrar configuraciÃ³n de ens34
      ansible.builtin.debug:
        var: ens34_config.stdout_lines
      
    - name: ğŸ“Š Verificar configuraciÃ³n resultante
      ansible.builtin.command: ip addr show
      register: final_config
      changed_when: false
      
    - name: ğŸ“‹ ConfiguraciÃ³n final de red
      ansible.builtin.debug:
        var: final_config.stdout_lines
        
    - name: ğŸ” Verificar IP asignada
      ansible.builtin.command: ip -4 addr show {{ lan_interface }}
      register: ip_check
      changed_when: false
      
    - name: ğŸŒ Verificar conectividad con gateway
      ansible.builtin.command: ping -c 3 192.168.50.1
      register: ping_gateway
      failed_when: false
      changed_when: false
      
    - name: ğŸ“¡ Resultado del ping
      ansible.builtin.debug:
        var: ping_gateway.stdout_lines
        
    - name: ğŸ”‘ Asegurar SSH estÃ¡ activo
      ansible.builtin.systemd:
        name: ssh
        state: started
        enabled: yes
        
    - name: ğŸ¯ Mostrar resultado
      ansible.builtin.debug:
        msg: |
          âœ… ConfiguraciÃ³n de mint_jhonatan completada:
          - Interfaz {{ lan_interface }} configurada para DHCP
          - Conectividad con gateway: {{ 'OK' if ping_gateway.rc == 0 else 'ERROR' }}
          - SSH: Activo
          
          ğŸ”¥ Si tienes IP asignada, puedes conectarte desde la VM de control:
          ssh jhonatan@[IP_ASIGNADA]