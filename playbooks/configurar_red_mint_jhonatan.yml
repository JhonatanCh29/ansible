---
# Playbook MEJORADO para configurar red en mint_jhonatan
# VersiÃ³n corregida que maneja mejor las conexiones
# Ejecutar con: ansible-playbook -c local -i localhost, playbooks/configurar_red_mint_jhonatan_v2.yml --become-method=sudo -K

- name: ğŸ’» ConfiguraciÃ³n de red MEJORADA - mint_jhonatan
  hosts: localhost
  become: yes
  connection: local
  gather_facts: no
  
  vars:
    ansible_python_interpreter: /usr/bin/python3
    lan_interface: "ens34"
    connection_name: "lab-dhcp-clean"
    
  tasks:
    - name: ğŸ“Š Estado inicial del sistema
      raw: |
        echo "=== ESTADO INICIAL ==="
        echo "Conexiones actuales:"
        nmcli connection show 2>/dev/null || echo "Sin conexiones"
        echo "Estado de ens34:"
        ip addr show ens34 2>/dev/null || echo "ens34 no disponible"
      register: estado_inicial
      
    - name: ğŸ§¹ Limpieza COMPLETA de ens34
      raw: |
        echo "ğŸ§¹ Iniciando limpieza completa..."
        
        # Parar NetworkManager
        systemctl stop NetworkManager 2>/dev/null || true
        sleep 2
        
        # Bajar interfaz
        ip link set ens34 down 2>/dev/null || true
        
        # Limpiar IPs y rutas
        ip addr flush dev ens34 2>/dev/null || true
        ip route flush dev ens34 2>/dev/null || true
        
        # Reiniciar NetworkManager
        systemctl start NetworkManager
        sleep 5
        
        # Eliminar cualquier conexiÃ³n residual despuÃ©s del reinicio
        nmcli -t -f NAME connection show 2>/dev/null | while read conn; do
          if [[ "$conn" == *"ens34"* ]] || [[ "$conn" == *"Wired"* ]] || [[ "$conn" == *"Ethernet"* ]] || [[ "$conn" == *"ethernet"* ]]; then
            echo "Eliminando: $conn"
            nmcli connection delete "$conn" 2>/dev/null || true
          fi
        done
        
        echo "âœ… Limpieza completada"
      
    - name: â±ï¸ Pausa para estabilizar NetworkManager
      raw: sleep 5
      
    - name: ğŸŒ Crear nueva conexiÃ³n DHCP limpia
      raw: |
        echo "ğŸŒ Creando conexiÃ³n DHCP nueva..."
        nmcli connection add \
          type ethernet \
          con-name "{{ connection_name }}" \
          ifname {{ lan_interface }} \
          autoconnect yes \
          ipv4.method auto \
          ipv6.method ignore \
          connection.autoconnect-priority 100
      register: crear_conexion
      failed_when: false
      
    - name: ğŸ”„ Verificar si la conexiÃ³n se creÃ³ correctamente
      raw: nmcli connection show "{{ connection_name }}" >/dev/null 2>&1 && echo "OK" || echo "ERROR"
      register: verificar_conexion
      
    - name: ğŸš€ Activar conexiÃ³n nueva
      raw: |
        echo "ğŸš€ Activando conexiÃ³n..."
        nmcli connection up "{{ connection_name }}"
      register: activar_conexion
      failed_when: false
      when: "'OK' in verificar_conexion.stdout"
      
    - name: â±ï¸ Esperar obtenciÃ³n de IP por DHCP
      raw: |
        echo "â±ï¸ Esperando DHCP (30 segundos)..."
        for i in {1..30}; do
          IP=$(ip addr show ens34 | grep "inet " | awk '{print $2}' | cut -d/ -f1)
          if [[ -n "$IP" ]] && [[ "$IP" != "127.0.0.1" ]]; then
            echo "âœ… IP obtenida: $IP"
            break
          fi
          echo "Intento $i/30: Esperando IP..."
          sleep 1
        done
      
    - name: ğŸ”§ Forzar renovaciÃ³n DHCP si es necesario
      raw: |
        IP=$(ip addr show ens34 | grep "inet " | awk '{print $2}' | cut -d/ -f1)
        if [[ -z "$IP" ]] || [[ "$IP" == "127.0.0.1" ]]; then
          echo "ğŸ”§ Forzando renovaciÃ³n DHCP..."
          dhclient -r ens34 2>/dev/null || true
          sleep 2
          dhclient ens34 2>/dev/null || true
          sleep 5
        fi
      
    - name: â¬†ï¸ Asegurar que ens34 estÃ© UP
      raw: |
        ip link set ens34 up 2>/dev/null || true
        sleep 2
      
    - name: ğŸ”‘ Activar SSH
      raw: |
        systemctl enable ssh 2>/dev/null || systemctl enable sshd 2>/dev/null || true
        systemctl start ssh 2>/dev/null || systemctl start sshd 2>/dev/null || true
      
    - name: ğŸ“Š Verificar configuraciÃ³n final
      raw: |
        echo "=== VERIFICACIÃ“N FINAL ==="
        echo "Estado de ens34:"
        ip addr show ens34
        echo ""
        echo "Conexiones activas:"
        nmcli connection show --active
        echo ""
        echo "Tabla de rutas:"
        ip route show | grep ens34 || echo "Sin rutas para ens34"
      register: estado_final
      
    - name: ğŸŒ Probar conectividad con gateway
      raw: |
        echo "ğŸŒ Probando conectividad con gateway..."
        if ping -c 3 -W 3 192.168.50.1 >/dev/null 2>&1; then
          echo "âœ… Conectividad OK con 192.168.50.1"
          exit 0
        else
          echo "âŒ Sin conectividad con 192.168.50.1"
          echo "Verificando rutas..."
          ip route show
          exit 1
        fi
      register: ping_result
      failed_when: false
      
    - name: ğŸ“‹ Mostrar resultado final
      debug:
        msg: |
          ğŸ‰ CONFIGURACIÃ“N DE MINT_JHONATAN COMPLETADA
          ============================================
          Estado: {{ 'Ã‰XITO' if ping_result.rc == 0 else 'PARCIAL' }}
          
          ğŸ“Š Detalles:
          {{ estado_final.stdout }}
          
          ğŸŒ Conectividad: {{ 'OK' if ping_result.rc == 0 else 'ERROR - Revisar configuraciÃ³n del router' }}
          
          âœ… mint_jhonatan estÃ¡ {{ 'lista para usar' if ping_result.rc == 0 else 'parcialmente configurada' }}