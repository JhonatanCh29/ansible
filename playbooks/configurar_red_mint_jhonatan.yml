---
# Playbook para configurar red inicial en mint_jhonatan
# Ejecutar con: ansible-playbook -c local -i localhost, playbooks/configurar_red_mint_jhonatan.yml --become-method=sudo -K

- name: ğŸ’» ConfiguraciÃ³n de red - mint_jhonatan
  hosts: localhost
  become: yes
  connection: local
  gather_facts: no
  
  vars:
    ansible_python_interpreter: /usr/bin/python3
    lan_interface: "ens34"
    
  tasks:
    - name: ğŸ”§ Configurar Python interpreter
      raw: which python3 || which python
      register: python_path
      changed_when: false
      
    - name: ğŸ§¹ Limpiar ens34
      raw: |
        ip link set ens34 down 2>/dev/null || true
        ip addr flush dev ens34 2>/dev/null || true
        nmcli connection show | grep ens34 | awk '{print $1}' | xargs -r nmcli connection delete 2>/dev/null || true
        ip link set ens34 up 2>/dev/null || true
        
    - name: ğŸ“¦ Instalar NetworkManager
      raw: apt update && apt install -y network-manager
      
    - name: ğŸ”Œ Activar NetworkManager
      raw: systemctl enable --now NetworkManager
      
    - name: ğŸŒ Configurar ens34 para DHCP del laboratorio
      raw: nmcli connection add type ethernet ifname ens34 con-name lan-dhcp ipv4.method auto connection.autoconnect yes
      
    - name: ğŸ”Œ Activar conexiÃ³n LAN
      raw: nmcli connection up lan-dhcp
      
    - name: â±ï¸ Esperar DHCP
      raw: sleep 10
      
    - name: ğŸ”„ Renovar DHCP si es necesario
      raw: dhclient -r ens34 && dhclient ens34
      
    - name: ğŸ”‘ Activar SSH
      raw: systemctl enable --now ssh
      
    - name: ğŸ“Š Verificar ens34
      raw: ip addr show ens34
      register: ens34_result
      
    - name: ğŸŒ Verificar conectividad con gateway
      raw: ping -c 3 192.168.50.1
      register: ping_result
      failed_when: false
      
    - name: âœ… Mostrar resultado
      debug:
        msg: |
          mint_jhonatan configurada:
          - ens34: DHCP habilitado ({{ ens34_result.stdout | regex_search('inet [0-9.]+') | default('IP pendiente') }})
          - Gateway: {{ 'OK' if ping_result.rc == 0 else 'ERROR' }}
          - SSH: Activo