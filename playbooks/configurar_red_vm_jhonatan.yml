---
# Playbook para configurar red inicial en vm_jhonatan
# Ejecutar con: ansible-playbook -c local -i localhost, playbooks/configurar_red_vm_jhonatan_limpio.yml

- name: ğŸŒ ConfiguraciÃ³n de red - vm_jhonatan (ejecutar EN vm_jhonatan)
  hosts: localhost
  become: yes
  connection: local
  gather_facts: yes
  
  vars:
    lan_interface: "ens34"  # Interfaz para la red local del laboratorio
    wan_interface: "ens35"  # Interfaz para WAN/Internet
    
  tasks:
    - name: ğŸ§¹ LIMPIAR interfaz ens34
      ansible.builtin.shell: |
        ip link set ens34 down 2>/dev/null || true
        ip addr flush dev ens34 2>/dev/null || true
        nmcli connection show | grep ens34 | awk '{print $1}' | xargs -r nmcli connection delete 2>/dev/null || true
        ip route flush dev ens34 2>/dev/null || true
        ip link set ens34 up 2>/dev/null || true
      register: cleanup_ens34
      
    - name: ğŸ§¹ LIMPIAR interfaz ens35
      ansible.builtin.shell: |
        ip link set ens35 down 2>/dev/null || true
        ip addr flush dev ens35 2>/dev/null || true
        nmcli connection show | grep ens35 | awk '{print $1}' | xargs -r nmcli connection delete 2>/dev/null || true
        ip route flush dev ens35 2>/dev/null || true
        ip link set ens35 up 2>/dev/null || true
      register: cleanup_ens35
      
    - name: ğŸ“‹ Resultado de limpieza
      ansible.builtin.debug:
        msg: "Interfaces ens34 y ens35 limpiadas"
        
    - name: Instalar NetworkManager en Fedora
      ansible.builtin.dnf:
        name: NetworkManager
        state: present
      when: ansible_distribution == 'Fedora'
      
    - name: Asegurar NetworkManager estÃ¡ corriendo
      ansible.builtin.systemd:
        name: NetworkManager
        state: started
        enabled: yes
        
    - name: ğŸŒ Configurar ens34 con IP estÃ¡tica del laboratorio
      ansible.builtin.command: >-
        nmcli connection add type ethernet 
        ifname ens34 
        con-name lab-lan 
        ipv4.method manual 
        ipv4.addresses 192.168.50.1/24 
        connection.autoconnect yes
      register: lan_config
      failed_when: lan_config.rc != 0 and 'already exists' not in lan_config.stderr
      
    - name: ğŸŒ Configurar ens35 para WAN con DHCP
      ansible.builtin.command: >-
        nmcli connection add type ethernet 
        ifname ens35 
        con-name wan-dhcp 
        ipv4.method auto 
        connection.autoconnect yes
      register: wan_config
      failed_when: wan_config.rc != 0 and 'already exists' not in wan_config.stderr
      
    - name: ğŸ”Œ Activar conexiÃ³n LAN
      ansible.builtin.command: nmcli connection up lab-lan
      register: lan_up
      failed_when: false
      
    - name: ğŸ”Œ Activar conexiÃ³n WAN
      ansible.builtin.command: nmcli connection up wan-dhcp
      register: wan_up
      failed_when: false
      
    - name: Esperar configuraciÃ³n de interfaces
      ansible.builtin.wait_for:
        timeout: 10
        
    - name: ğŸš€ Habilitar forwarding IP
      ansible.builtin.command: sysctl -w net.ipv4.ip_forward=1
      
    - name: ğŸ“ Hacer forwarding IP persistente
      ansible.builtin.lineinfile:
        path: /etc/sysctl.conf
        line: 'net.ipv4.ip_forward=1'
        create: yes
        
    - name: ğŸ”‘ Activar SSH
      ansible.builtin.systemd:
        name: sshd
        state: started
        enabled: yes
        
    - name: ğŸ“Š Verificar ens34
      ansible.builtin.command: ip addr show ens34
      register: ens34_check
      changed_when: false
      
    - name: ğŸ“Š Verificar ens35
      ansible.builtin.command: ip addr show ens35
      register: ens35_check
      changed_when: false
      
    - name: ğŸ“‹ Mostrar configuraciÃ³n ens34
      ansible.builtin.debug:
        var: ens34_check.stdout_lines
        
    - name: ğŸ“‹ Mostrar configuraciÃ³n ens35
      ansible.builtin.debug:
        var: ens35_check.stdout_lines
        
    - name: ğŸ¯ Resultado final
      ansible.builtin.debug:
        msg: |
          âœ… vm_jhonatan configurada como router:
          - ens34: 192.168.50.1/24 (LAN del laboratorio)
          - ens35: DHCP (WAN/Internet)
          - Forwarding IP: Habilitado
          - SSH: Activo
          
          ğŸ”¥ Conectarse desde VM control: ssh jhonatan@192.168.50.1