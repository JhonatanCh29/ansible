---
# Playbook para configurar red inicial en vm_jhonatan
# Ejecutar con: ansible-playbook -c local -i localhost, playbooks/configurar_red_vm_jhonatan.yml --become-method=sudo -K

- name: ðŸŒ ConfiguraciÃ³n de red - vm_jhonatan
  hosts: localhost
  become: yes
  connection: local
  gather_facts: no
  
  vars:
    ansible_python_interpreter: /usr/bin/python3
    lan_interface: "ens34"
    wan_interface: "ens35"
    
  tasks:
    - name: ðŸ”§ Configurar Python interpreter
      raw: which python3 || which python
      register: python_path
      changed_when: false
      
    - name: ðŸ§¹ Limpiar ens34
      raw: |
        ip link set ens34 down 2>/dev/null || true
        ip addr flush dev ens34 2>/dev/null || true
        nmcli connection show | grep ens34 | awk '{print $1}' | xargs -r nmcli connection delete 2>/dev/null || true
        ip link set ens34 up 2>/dev/null || true
      
    - name: ðŸ§¹ Limpiar ens35
      raw: |
        ip link set ens35 down 2>/dev/null || true
        ip addr flush dev ens35 2>/dev/null || true
        nmcli connection show | grep ens35 | awk '{print $1}' | xargs -r nmcli connection delete 2>/dev/null || true
        ip link set ens35 up 2>/dev/null || true
        
    - name: ðŸ“¦ Instalar NetworkManager
      raw: dnf install -y NetworkManager
      
    - name: ðŸ”Œ Activar NetworkManager
      raw: systemctl enable --now NetworkManager
      
    - name: ðŸŒ Configurar ens34 LAN
      raw: nmcli connection add type ethernet ifname ens34 con-name lab-lan ipv4.method manual ipv4.addresses 192.168.50.1/24 connection.autoconnect yes
      
    - name: ðŸŒ Configurar ens35 WAN  
      raw: nmcli connection add type ethernet ifname ens35 con-name wan-dhcp ipv4.method auto connection.autoconnect yes
      
    - name: ðŸ”Œ Activar LAN
      raw: nmcli connection up lab-lan
      
    - name: ðŸ”Œ Activar WAN
      raw: nmcli connection up wan-dhcp
      
    - name: ðŸš€ Habilitar forwarding
      raw: sysctl -w net.ipv4.ip_forward=1
      
    - name: ðŸ“ Forwarding persistente
      raw: echo 'net.ipv4.ip_forward=1' >> /etc/sysctl.conf
      
    - name: ðŸ”‘ Activar SSH
      raw: systemctl enable --now sshd
      
    - name: ðŸ“Š Verificar ens34
      raw: ip addr show ens34
      register: ens34_result
      
    - name: ï¿½ Verificar ens35
      raw: ip addr show ens35
      register: ens35_result
      
    - name: âœ… Mostrar resultado
      debug:
        msg: |
          vm_jhonatan configurada:
          - ens34: 192.168.50.1/24 (LAN)
          - ens35: DHCP (WAN)
          - SSH: Activo
          - Forwarding: Habilitado