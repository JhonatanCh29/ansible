---
# Playbook para verificar el estado final y crear un reporte del Nivel 4
- name: ğŸ“Š VerificaciÃ³n final Ansible Nivel 4 - Laboratorio AcadÃ©mico
  hosts: lab_academico
  become: yes
  gather_facts: yes
  
  tasks:
    - name: ğŸ“Š Recopilar informaciÃ³n del sistema
      debug:
        msg: |
          ğŸ–¥ï¸  HOST: {{ inventory_hostname }}
          ğŸ”§ OS: {{ ansible_facts['distribution'] | default('Unknown') }} {{ ansible_facts['distribution_version'] | default('') }}
          ğŸŒ IP ens34: {{ ansible_facts['ens34']['ipv4']['address'] | default('No configurada') if 'ens34' in ansible_facts else 'Interfaz ens34 no detectada' }}
          ğŸ’¾ Memoria: {{ (ansible_facts['memtotal_mb'] / 1024) | round(1) }}GB
          ğŸ’¿ Disco: {{ ansible_facts['devices']['sda']['size'] | default('N/A') if 'sda' in ansible_facts.get('devices', {}) else 'N/A' }}
          â° Uptime: {{ ansible_facts['uptime_seconds'] | default(0) | int // 3600 }}h
    
    - name: âœ… Verificar volÃºmenes LVM creados
      shell: |
        echo "=== VOLÃšMENES LVM ==="
        lvs 2>/dev/null | grep -E "(logs-lv|backups-lv)" || echo "LVM no configurado"
      register: lvm_status
      failed_when: false
      
    - name: âœ… Verificar directorios de logs y backups
      shell: |
        echo "=== DIRECTORIOS IMPORTANTES ==="
        ls -la /var/log/lab 2>/dev/null || echo "/var/log/lab: No existe"
        ls -la /var/backups 2>/dev/null || echo "/var/backups: No existe" 
        echo "=== SCRIPTS AUTOMATIZADOS ==="
        ls -la /usr/local/bin/*backup* 2>/dev/null || echo "Scripts backup: No encontrados"
        ls -la /usr/local/bin/*monitor* 2>/dev/null || echo "Scripts monitor: No encontrados"
      register: dirs_status
      failed_when: false
      
    - name: âœ… Verificar servicios crÃ­ticos
      shell: |
        echo "=== SERVICIOS CRÃTICOS ==="
        systemctl is-active sshd 2>/dev/null || echo "sshd: Inactivo"
        systemctl is-active crond 2>/dev/null || systemctl is-active cron 2>/dev/null || echo "cron: Inactivo"
        if [ "{{ inventory_hostname }}" = "vm_jhonatan" ]; then
          systemctl is-active dnsmasq 2>/dev/null || echo "dnsmasq: Inactivo"
        fi
      register: services_status
      failed_when: false
      
    - name: âœ… Verificar configuraciÃ³n de red
      shell: |
        echo "=== CONFIGURACIÃ“N DE RED ==="
        ip addr show ens34 | grep inet || echo "ens34: Sin IP"
        if [ "{{ inventory_hostname }}" = "vm_jhonatan" ]; then
          echo "=== ROUTER CONFIGURATION ==="
          iptables -t nat -L POSTROUTING | grep MASQUERADE || echo "NAT: No configurado"
          cat /proc/sys/net/ipv4/ip_forward || echo "IP Forward: No configurado"
        fi
      register: network_status
      failed_when: false
      
    - name: ğŸ“‹ Mostrar resumen por host
      debug:
        msg: |
          
          ğŸ¯ RESUMEN NIVEL 4 - {{ inventory_hostname }}
          =======================================
          
          ğŸ’¾ Almacenamiento:
          {{ lvm_status.stdout }}
          
          ğŸ“ Directorios y Scripts:
          {{ dirs_status.stdout }}
          
          ğŸ”§ Servicios:
          {{ services_status.stdout }}
          
          ğŸŒ Red:
          {{ network_status.stdout }}

- name: ğŸ“Š Reporte Final del Laboratorio
  hosts: localhost
  gather_facts: no
  tasks:
    - name: ğŸ‰ Estado final del proyecto Ansible Nivel 4
      debug:
        msg: |
          
          ğŸ† PROYECTO ANSIBLE NIVEL 4 COMPLETADO
          ====================================
          
          âœ… ROLES IMPLEMENTADOS:
          - almacenamiento_sistemas: GestiÃ³n LVM, backups automatizados
          - procesos_servicios: Monitoreo de servicios y procesos
          - red_lab: ConfiguraciÃ³n de laboratorio de red (router/cliente)
          - tareas_automatizadas: Scripts y automatizaciÃ³n del sistema
          - usuarios_permisos: GestiÃ³n de usuarios y permisos
          
          ğŸŒ INFRAESTRUCTURA:
          - vm_jhonatan (192.168.50.1): Router con DHCP y NAT
          - mint_jhonatan (192.168.50.20): Cliente del laboratorio
          - vm_control (192.168.50.10): Centro de control Ansible
          
          ğŸ¯ NIVEL 4 CARACTERÃSTICAS IMPLEMENTADAS:
          âœ… GestiÃ³n avanzada de almacenamiento (LVM)
          âœ… AutomatizaciÃ³n de backups con retenciÃ³n
          âœ… Monitoreo proactivo de recursos
          âœ… GestiÃ³n de usuarios con auditorÃ­a
          âœ… ConfiguraciÃ³n de red completa del laboratorio
          âœ… Scripts de automatizaciÃ³n personalizados
          âœ… Logging centralizado
          
          ğŸš€ Â¡IMPLEMENTACIÃ“N EXITOSA DE ANSIBLE NIVEL 4!