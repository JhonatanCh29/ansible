---
# Playbook para configurar red en la VM de control
# Ejecutar con: ansible-playbook -c local -i localhost, playbooks/configurar_red_control.yml

- name: ğŸ’» ConfiguraciÃ³n de red - VM de control (ejecutar EN la VM de control)
  hosts: localhost
  become: yes
  connection: local
  gather_facts: yes
  
  vars:
    # Interfaz correcta segÃºn ip addr show
    lan_interface: "ens34"  # Interfaz para la red local del laboratorio
    control_ip: "192.168.50.10"  # IP estÃ¡tica para la VM de control
    
  tasks:
    - name: Mostrar interfaces disponibles
      ansible.builtin.command: ip link show
      register: interfaces
      changed_when: false
      
    - name: ğŸ“‹ Interfaces detectadas
      ansible.builtin.debug:
        var: interfaces.stdout_lines
        
    - name: ğŸ§¹ LIMPIAR COMPLETAMENTE la interfaz ens34
      ansible.builtin.shell: |
        # Bajar la interfaz
        ip link set ens34 down 2>/dev/null || true
        # Limpiar cualquier IP asignada
        ip addr flush dev ens34 2>/dev/null || true
        # Eliminar todas las conexiones de NetworkManager en ens34
        nmcli connection show | grep ens34 | awk '{print $1}' | xargs -r nmcli connection delete 2>/dev/null || true
        # Subir la interfaz limpia
        ip link set ens34 up 2>/dev/null || true
      register: cleanup_ens34
      
    - name: ğŸ“‹ Resultado de limpieza ens34
      ansible.builtin.debug:
        var: cleanup_ens34.stdout_lines
        
    - name: Detectar distribuciÃ³n
      ansible.builtin.set_fact:
        is_mint: "{{ 'mint' in ansible_distribution|lower or 'ubuntu' in ansible_distribution|lower }}"
        
    - name: Instalar NetworkManager si no estÃ¡ (Mint/Ubuntu)
      ansible.builtin.apt:
        name: network-manager
        state: present
        update_cache: yes
      when: is_mint
      
    - name: Asegurar NetworkManager estÃ¡ corriendo
      ansible.builtin.systemd:
        name: NetworkManager
        state: started
        enabled: yes
        
    - name: Eliminar conexiones existentes que puedan conflictuar
      ansible.builtin.command: nmcli connection delete "{{ item }}"
      loop:
        - "control-lan"
        - "Wired connection 1"
        - "Wired connection 2"
      failed_when: false
      changed_when: false
      
    - name: ğŸŒ Configurar interfaz con IP estÃ¡tica en la red del laboratorio
      ansible.builtin.command: >-
        nmcli connection add type ethernet 
        ifname {{ lan_interface }} 
        con-name control-lan 
        ipv4.method manual 
        ipv4.addresses {{ control_ip }}/24 
        ipv4.gateway 192.168.50.1
        ipv4.dns "192.168.50.1 8.8.8.8"
        connection.autoconnect yes
      register: lan_config
      failed_when: lan_config.rc != 0 and 'already exists' not in lan_config.stderr
      
    - name: ğŸ”Œ Activar conexiÃ³n LAN
      ansible.builtin.command: nmcli connection up control-lan
      register: lan_up
      failed_when: false
      
    - name: Esperar a que la interfaz se configure
      ansible.builtin.wait_for:
        timeout: 10
        
    - name: ğŸ“Š Verificar configuraciÃ³n de ens34
      ansible.builtin.command: ip addr show ens34
      register: ens34_config
      changed_when: false
      
    - name: ğŸ“Š Verificar tabla de rutas
      ansible.builtin.command: ip route show
      register: route_config
      changed_when: false
      
    - name: ğŸ“‹ Mostrar configuraciÃ³n de ens34
      ansible.builtin.debug:
        var: ens34_config.stdout_lines
        
    - name: ğŸ“‹ Mostrar tabla de rutas
      ansible.builtin.debug:
        var: route_config.stdout_lines
        
    - name: ğŸ“Š Verificar configuraciÃ³n resultante
      ansible.builtin.command: ip addr show
      register: final_config
      changed_when: false
      
    - name: ğŸ“‹ ConfiguraciÃ³n final de red
      ansible.builtin.debug:
        var: final_config.stdout_lines
        
    - name: ğŸŒ Verificar conectividad con vm_jhonatan (gateway)
      ansible.builtin.command: ping -c 3 192.168.50.1
      register: ping_gateway
      failed_when: false
      changed_when: false
      
    - name: ğŸ“¡ Resultado del ping al gateway
      ansible.builtin.debug:
        var: ping_gateway.stdout_lines
        
    - name: ğŸ” Verificar conectividad con mint_jhonatan (si estÃ¡ en lÃ­nea)
      ansible.builtin.command: ping -c 2 192.168.50.100
      register: ping_mint
      failed_when: false
      changed_when: false
      
    - name: ğŸ“¡ Resultado del ping a mint_jhonatan
      ansible.builtin.debug:
        var: ping_mint.stdout_lines
      when: ping_mint.rc == 0
        
    - name: ğŸ”‘ Verificar que SSH cliente estÃ¡ instalado
      ansible.builtin.package:
        name: openssh-client
        state: present
        
    - name: ğŸ¯ Mostrar resultado final
      ansible.builtin.debug:
        msg: |
          âœ… ConfiguraciÃ³n de VM de control completada:
          - IP: {{ control_ip }}/24 en {{ lan_interface }}
          - Gateway: 192.168.50.1 (vm_jhonatan)
          - DNS: 192.168.50.1, 8.8.8.8
          - Conectividad con gateway: {{ 'OK' if ping_gateway.rc == 0 else 'ERROR' }}
          
          ğŸ”¥ Ahora puedes usar Ansible para gestionar las otras VMs:
          ansible all -m ping