---
- name: Limpieza agresiva de interfaces de red en VMs del laboratorio
  hosts: mint_jhonatan
  gather_facts: no
  become: yes
  vars:
    ansible_python_interpreter: /usr/bin/python3

  tasks:
    - name: "ğŸ“Š Mostrar conexiones actuales ANTES de limpiar"
      raw: nmcli connection show 2>/dev/null || echo "No hay conexiones"
      register: conexiones_antes
      
    - name: "ğŸ“Š Mostrar estado de ens34 ANTES"
      raw: ip addr show ens34 2>/dev/null || echo "ens34 no encontrada"
      register: ens34_antes
      
    - name: "ğŸ”¥ Parar NetworkManager temporalmente"
      raw: systemctl stop NetworkManager
      
    - name: "â¬‡ï¸ Bajar interfaz ens34"
      raw: ip link set ens34 down 2>/dev/null || true
      
    - name: "ğŸ§¹ Limpiar TODAS las IPs de ens34"
      raw: ip addr flush dev ens34 2>/dev/null || true
      
    - name: "ğŸ—ºï¸ Limpiar rutas de ens34"
      raw: ip route flush dev ens34 2>/dev/null || true
      
    - name: "ğŸ—‘ï¸ Limpiar cache ARP de ens34"
      raw: ip neigh flush dev ens34 2>/dev/null || true
      
    - name: "ğŸ”„ Reiniciar NetworkManager"
      raw: systemctl start NetworkManager
      
    - name: "â±ï¸ Esperar que NetworkManager se estabilice"
      raw: sleep 5
      
    - name: "ğŸ—‘ï¸ Eliminar TODAS las conexiones automÃ¡ticas de ethernet"
      raw: |
        nmcli -t -f NAME,DEVICE connection show 2>/dev/null | while IFS=':' read name device; do
          if [[ "$name" == *"ens34"* ]] || [[ "$device" == "ens34" ]] || [[ "$name" == *"Wired"* ]] || [[ "$name" == *"Ethernet"* ]] || [[ "$name" == *"ethernet"* ]]; then
            echo "Eliminando: $name"
            nmcli connection delete "$name" 2>/dev/null || true
          fi
        done
      register: eliminacion_conexiones
      
    - name: "â±ï¸ Pausa despuÃ©s de eliminar conexiones"
      raw: sleep 3
      
    - name: "â¬†ï¸ Subir interfaz ens34 limpia"
      raw: ip link set ens34 up 2>/dev/null || true
      
    - name: "â±ï¸ Pausa final para estabilizar"
      raw: sleep 3
      
    - name: "âœ… Crear nueva conexiÃ³n DHCP para ens34"
      raw: nmcli connection add type ethernet con-name "lab-ens34" ifname ens34 autoconnect yes
      
    - name: "ğŸ”§ Configurar conexiÃ³n para DHCP"
      raw: nmcli connection modify "lab-ens34" ipv4.method auto ipv6.method ignore
      
    - name: "ğŸš€ Activar nueva conexiÃ³n"
      raw: nmcli connection up "lab-ens34"
      
    - name: "â±ï¸ Esperar obtenciÃ³n de IP por DHCP"
      raw: sleep 10
      
    - name: "ğŸ“Š Mostrar estado FINAL de ens34"
      raw: ip addr show ens34
      register: estado_final
      
    - name: "ğŸ“Š Mostrar conexiones FINALES"
      raw: nmcli connection show
      register: conexiones_finales
      
    - name: "ğŸ§ª Probar conectividad con gateway (192.168.50.1)"
      raw: ping -c 3 192.168.50.1 || echo "No hay conectividad con gateway aÃºn"
      register: test_conectividad

  handlers:
    - name: "ğŸ”„ Reiniciar NetworkManager si es necesario"
      raw: systemctl restart NetworkManager

- name: Mostrar resultados de la limpieza
  hosts: localhost
  gather_facts: no
  tasks:
    - name: "ğŸ“‹ Resumen de la limpieza agresiva"
      debug:
        msg: |
          ğŸ”¥ LIMPIEZA AGRESIVA COMPLETADA
          ===============================
          âœ… Interfaces limpiadas y reconfiguradas
          âœ… Nueva conexiÃ³n DHCP creada: lab-ens34
          âœ… Lista para obtener IP automÃ¡tica del router (vm_jhonatan)